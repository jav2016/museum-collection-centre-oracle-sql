-- ============================================================
-- MUSEUM COLLECTIONS MANAGEMENT DATABASE - FIXED VERSION
-- Fixes: ORA-00955 (object exists) and ORA-65096 (role naming)
-- ============================================================

-- Disable substitution variables (fixes "Enter value for watt" prompt)
SET DEFINE OFF;
SET SQLBLANKLINES ON;

-- ============================
-- PART 0: CLEANUP (DROP EXISTING OBJECTS)
-- ============================
-- Run this section to remove existing objects before recreating

-- Drop views first
BEGIN EXECUTE IMMEDIATE 'DROP VIEW vw_PublicMuseumObjects'; EXCEPTION WHEN OTHERS THEN NULL; END;
/

-- Drop indexes (some may be dropped automatically with tables)
BEGIN EXECUTE IMMEDIATE 'DROP INDEX IDX_LOAN_STATUS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP INDEX IDX_LOANITEM_OBJ'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP INDEX IDX_CR_OBJECTDATE'; EXCEPTION WHEN OTHERS THEN NULL; END;
/

-- Drop tables in reverse dependency order (child tables first)
BEGIN EXECUTE IMMEDIATE 'DROP TABLE Movement CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE ConditionReport CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE ExhibitionItem CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE LoanItem CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE Exhibition CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE Loan CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE MuseumObject CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE Acquisition CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE Location CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE Staff CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE Contact CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/

-- Drop roles (for PDB environment)
BEGIN EXECUTE IMMEDIATE 'DROP ROLE role_collections_staff'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP ROLE role_loans_officer'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP ROLE role_conservator'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP ROLE role_admin'; EXCEPTION WHEN OTHERS THEN NULL; END;
/

-- ============================
-- PART 1: CREATE TABLES
-- ============================
CREATE TABLE Contact (
  ContactID    NUMBER GENERATED BY DEFAULT AS IDENTITY,
  Name         VARCHAR2(100) NOT NULL,
  ContactType  VARCHAR2(30)  NOT NULL,
  Phone        VARCHAR2(30),
  Email        VARCHAR2(120),
  CONSTRAINT PK_Contact PRIMARY KEY (ContactID),
  CONSTRAINT CK_Contact_Type
  CHECK (ContactType IN ('Donor','Lender','Borrower','Organisation','Partner','Other'))
);

CREATE TABLE Staff (
  StaffID     NUMBER GENERATED BY DEFAULT AS IDENTITY,
  Name        VARCHAR2(100) NOT NULL,
  Role        VARCHAR2(60)  NOT NULL,
  Department  VARCHAR2(60),
  CONSTRAINT PK_Staff PRIMARY KEY (StaffID)
);

CREATE TABLE Location (
  LocationID    NUMBER GENERATED BY DEFAULT AS IDENTITY,
  LocationName  VARCHAR2(120) NOT NULL,
  LocationType  VARCHAR2(40)  NOT NULL,
  CONSTRAINT PK_Location PRIMARY KEY (LocationID),
  CONSTRAINT CK_Location_Type
  CHECK (LocationType IN ('Storage','Gallery','Exhibition','Conservation','Transit','External','Other'))
);

CREATE TABLE Acquisition (
  AcquisitionID    NUMBER GENERATED BY DEFAULT AS IDENTITY,
  AcquisitionDate  DATE NOT NULL,
  Method           VARCHAR2(40) NOT NULL,
  ContactID        NUMBER NOT NULL,
  Notes            VARCHAR2(400),
  CONSTRAINT PK_Acquisition PRIMARY KEY (AcquisitionID),
  CONSTRAINT FK_Acquisition_Contact
  FOREIGN KEY (ContactID) REFERENCES Contact(ContactID),
  CONSTRAINT CK_Acquisition_Method
  CHECK (Method IN ('Donation','Transfer','Bequest','LongTermDeposit','Other'))
);

CREATE TABLE MuseumObject (
  ObjectID       NUMBER GENERATED BY DEFAULT AS IDENTITY,
  ObjectName     VARCHAR2(150) NOT NULL,
  Description    VARCHAR2(500),
  Category       VARCHAR2(60)  NOT NULL,
  Status         VARCHAR2(30)  NOT NULL,
  AcquisitionID  NUMBER NOT NULL,
  LocationID     NUMBER NOT NULL,
  CONSTRAINT PK_MuseumObject PRIMARY KEY (ObjectID),
  CONSTRAINT FK_Object_Acquisition
  FOREIGN KEY (AcquisitionID) REFERENCES Acquisition(AcquisitionID),
  CONSTRAINT FK_Object_Location
  FOREIGN KEY (LocationID) REFERENCES Location(LocationID),
  CONSTRAINT CK_Object_Status
  CHECK (Status IN ('InStorage','OnDisplay','OnLoan','InTransit','UnderConservation','Other'))
);

CREATE TABLE Loan (
  LoanID     NUMBER GENERATED BY DEFAULT AS IDENTITY,
  LoanType   VARCHAR2(20) NOT NULL,
  ContactID  NUMBER NOT NULL,
  StaffID    NUMBER NOT NULL,
  StartDate  DATE NOT NULL,
  EndDate    DATE,
  Purpose    VARCHAR2(200),
  Status     VARCHAR2(20) NOT NULL,
  CONSTRAINT PK_Loan PRIMARY KEY (LoanID),
  CONSTRAINT FK_Loan_Contact
  FOREIGN KEY (ContactID) REFERENCES Contact(ContactID),
  CONSTRAINT FK_Loan_Staff
  FOREIGN KEY (StaffID) REFERENCES Staff(StaffID),
  CONSTRAINT CK_Loan_Type
  CHECK (LoanType IN ('Incoming','Outgoing')),
  CONSTRAINT CK_Loan_Status
  CHECK (Status IN ('Planned','Active','Closed','Cancelled')),
  CONSTRAINT CK_Loan_Date
  CHECK (EndDate IS NULL OR EndDate >= StartDate)
);

CREATE TABLE Exhibition (
  ExhibitionID  NUMBER GENERATED BY DEFAULT AS IDENTITY,
  Title         VARCHAR2(150) NOT NULL,
  Venue         VARCHAR2(150),
  StartDate     DATE NOT NULL,
  EndDate       DATE,
  StaffID       NUMBER NOT NULL,
  CONSTRAINT PK_Exhibition PRIMARY KEY (ExhibitionID),
  CONSTRAINT FK_Exhibition_Staff
  FOREIGN KEY (StaffID) REFERENCES Staff(StaffID),
  CONSTRAINT CK_Exhibition_Date
  CHECK (EndDate IS NULL OR EndDate >= StartDate)
);

CREATE TABLE LoanItem (
  LoanID          NUMBER NOT NULL,
  ObjectID        NUMBER NOT NULL,
  ConditionAtLoan VARCHAR2(80),
  ItemStatus      VARCHAR2(20) NOT NULL,
  CONSTRAINT PK_LoanItem PRIMARY KEY (LoanID, ObjectID),
  CONSTRAINT FK_LoanItem_Loan
  FOREIGN KEY (LoanID) REFERENCES Loan(LoanID),
  CONSTRAINT FK_LoanItem_Object
  FOREIGN KEY (ObjectID) REFERENCES MuseumObject(ObjectID),
  CONSTRAINT CK_LoanItem_Status
  CHECK (ItemStatus IN ('Included','Returned','Damaged','Missing','Other'))
);

CREATE TABLE ExhibitionItem (
  ExhibitionID  NUMBER NOT NULL,
  ObjectID      NUMBER NOT NULL,
  CONSTRAINT PK_ExhibitionItem PRIMARY KEY (ExhibitionID, ObjectID),
  CONSTRAINT FK_ExhItem_Exhibition
  FOREIGN KEY (ExhibitionID) REFERENCES Exhibition(ExhibitionID),
  CONSTRAINT FK_ExhItem_Object
  FOREIGN KEY (ObjectID) REFERENCES MuseumObject(ObjectID)
);

CREATE TABLE ConditionReport (
  ReportID         NUMBER GENERATED BY DEFAULT AS IDENTITY,
  ObjectID         NUMBER NOT NULL,
  ReportDate       DATE NOT NULL,
  ConditionStatus  VARCHAR2(40) NOT NULL,
  Notes            VARCHAR2(400),
  StaffID          NUMBER NOT NULL,
  CONSTRAINT PK_ConditionReport PRIMARY KEY (ReportID),
  CONSTRAINT FK_CR_Object
  FOREIGN KEY (ObjectID) REFERENCES MuseumObject(ObjectID),
  CONSTRAINT FK_CR_Staff
  FOREIGN KEY (StaffID) REFERENCES Staff(StaffID),
  CONSTRAINT CK_CR_Status
  CHECK (ConditionStatus IN ('Excellent','Good','Fair','Poor','AtRisk','UnderTreatment','Other'))
);

CREATE TABLE Movement (
  MovementID      NUMBER GENERATED BY DEFAULT AS IDENTITY,
  ObjectID        NUMBER NOT NULL,
  FromLocationID  NUMBER NOT NULL,
  ToLocationID    NUMBER NOT NULL,
  MovementDate    DATE NOT NULL,
  StaffID         NUMBER NOT NULL,
  CONSTRAINT PK_Movement PRIMARY KEY (MovementID),
  CONSTRAINT FK_Movement_Object
  FOREIGN KEY (ObjectID) REFERENCES MuseumObject(ObjectID),
  CONSTRAINT FK_Movement_FromLoc
  FOREIGN KEY (FromLocationID) REFERENCES Location(LocationID),
  CONSTRAINT FK_Movement_ToLoc
  FOREIGN KEY (ToLocationID) REFERENCES Location(LocationID),
  CONSTRAINT FK_Movement_Staff
  FOREIGN KEY (StaffID) REFERENCES Staff(StaffID),
  CONSTRAINT CK_Movement_Loc
  CHECK (FromLocationID <> ToLocationID)
);

-- ================================
-- PART 2: INSERT DATA
-- ================================

-- Contact
INSERT INTO Contact (ContactID, Name, ContactType, Phone, Email) VALUES (1,'Birmingham Heritage Society','Organisation','0121-111-1001','heritage@bhs.org.uk');
INSERT INTO Contact VALUES (2,'Midlands University Gallery','Borrower','0121-111-1002','loans@miduni.ac.uk');
INSERT INTO Contact VALUES (3,'West Midlands Archive','Partner','0121-111-1003','contact@wma.org.uk');
INSERT INTO Contact VALUES (4,'Private Donor A','Donor','0121-111-1004','donorA@mail.com');
INSERT INTO Contact VALUES (5,'City Library Birmingham','Borrower','0121-111-1005','exhibitions@librarybham.uk');
INSERT INTO Contact VALUES (6,'National Museum Network','Lender','0121-111-1006','registrar@nmn.org.uk');
INSERT INTO Contact VALUES (7,'Conservation Partner Ltd','Partner','0121-111-1007','service@conserve.co.uk');
INSERT INTO Contact VALUES (8,'Local Artist Estate','Donor','0121-111-1008','estate@artist.uk');
INSERT INTO Contact VALUES (9,'Regional Science Centre','Borrower','0121-111-1009','collections@sciencecentre.uk');
INSERT INTO Contact VALUES (10,'External Storage Vendor','Other','0121-111-1010','ops@storagevendor.uk');

-- Staff
INSERT INTO Staff (StaffID, Name, Role, Department) VALUES (1,'Ayesha Khan','Collections Access Officer','Collections');
INSERT INTO Staff VALUES (2,'Hassan Ali','Registrar','Collections');
INSERT INTO Staff VALUES (3,'Sara Malik','Conservator','Conservation');
INSERT INTO Staff VALUES (4,'Tom Williams','Curator','Curatorial');
INSERT INTO Staff VALUES (5,'Fatima Noor','Documentation Officer','Collections');
INSERT INTO Staff VALUES (6,'James Patel','Exhibitions Coordinator','Exhibitions');
INSERT INTO Staff VALUES (7,'Maryam Iqbal','Collections Assistant','Collections');
INSERT INTO Staff VALUES (8,'Daniel Green','Logistics Technician','Operations');
INSERT INTO Staff VALUES (9,'Imran Shah','Loans Officer','Collections');
INSERT INTO Staff VALUES (10,'Nadia Hassan','Collection Manager','Collections');

-- Location
INSERT INTO Location (LocationID, LocationName, LocationType) VALUES (1,'MCC Store Room A - Shelf 1','Storage');
INSERT INTO Location VALUES (2,'MCC Store Room A - Shelf 2','Storage');
INSERT INTO Location VALUES (3,'BMAG Gallery 1','Gallery');
INSERT INTO Location VALUES (4,'BMAG Gallery 2','Gallery');
INSERT INTO Location VALUES (5,'Conservation Lab 1','Conservation');
INSERT INTO Location VALUES (6,'Transit Holding Area','Transit');
INSERT INTO Location VALUES (7,'External Venue - Midlands University','External');
INSERT INTO Location VALUES (8,'External Venue - City Library','External');
INSERT INTO Location VALUES (9,'External Venue - Science Centre','External');
INSERT INTO Location VALUES (10,'Offsite Storage Facility','Storage');

-- Acquisition
INSERT INTO Acquisition (AcquisitionID, AcquisitionDate, Method, ContactID, Notes) VALUES (1, DATE '2020-01-15','Donation',4,'Victorian pottery collection donated by private collector.');
INSERT INTO Acquisition VALUES (2, DATE '2021-04-10','Transfer',1,'Heritage artefacts transferred from regional society.');
INSERT INTO Acquisition VALUES (3, DATE '2019-09-01','Bequest',8,'Art estate bequest to museum.');
INSERT INTO Acquisition VALUES (4, DATE '2022-06-30','LongTermDeposit',6,'Artefacts from National Network on 5-year deposit.');
INSERT INTO Acquisition VALUES (5, DATE '2023-11-20','Other',3,'Archive documents for digitisation project.');

-- MuseumObject
INSERT INTO MuseumObject (ObjectID, ObjectName, Description, Category, Status, AcquisitionID, LocationID) VALUES (1,'Victorian Tea Set','Complete porcelain tea set, 12 pieces','Decorative Arts','OnLoan',1,7);
INSERT INTO MuseumObject VALUES (2,'Industrial Loom','Working model from 1890s textile mill','Industrial Heritage','InStorage',2,2);
INSERT INTO MuseumObject VALUES (3,'Iron Age Brooch','Bronze and enamel brooch, circa 200 BCE','Archaeology','OnDisplay',2,3);
INSERT INTO MuseumObject VALUES (4,'Oil Portrait - Lady Cadbury','Portrait painting by local artist, 1905','Fine Art','UnderConservation',3,5);
INSERT INTO MuseumObject VALUES (5,'Medieval Manuscript','Illuminated manuscript, 14th century','Archives','OnDisplay',5,4);
INSERT INTO MuseumObject VALUES (6,'Roman Coin Hoard','Set of 45 coins, found in Sutton Coldfield','Numismatics','OnDisplay',2,3);
INSERT INTO MuseumObject VALUES (7,'Steam Engine Model','Scale model, Boulton & Watt design','Industrial Heritage','InStorage',2,1);
INSERT INTO MuseumObject VALUES (8,'Modern Sculpture - Unity','Abstract bronze sculpture, 2010','Contemporary Art','InTransit',3,6);
INSERT INTO MuseumObject VALUES (9,'Georgian Silverware Set','Hallmarked silver, 1780s','Decorative Arts','OnLoan',4,7);
INSERT INTO MuseumObject VALUES (10,'Victorian Photograph Album','Family album with 100+ images','Social History','Other',1,10);

-- Loan
INSERT INTO Loan (LoanID, LoanType, ContactID, StaffID, StartDate, EndDate, Purpose, Status) VALUES (1,'Outgoing',2,9, DATE '2025-03-01', DATE '2025-09-01','University exhibition',  'Active');
INSERT INTO Loan VALUES (2,'Outgoing',5,9, DATE '2024-11-01', DATE '2025-02-28','Public library display','Closed');
INSERT INTO Loan VALUES (3,'Incoming',6,9, DATE '2025-01-15', DATE '2026-01-15','Long-term deposit display','Active');
INSERT INTO Loan VALUES (4,'Outgoing',9,9, DATE '2025-05-01', DATE '2025-08-01','Science history showcase','Planned');

-- LoanItem
INSERT INTO LoanItem (LoanID, ObjectID, ConditionAtLoan, ItemStatus) VALUES (1,1,'Excellent','Included');
INSERT INTO LoanItem VALUES (1,9,'Good','Included');
INSERT INTO LoanItem VALUES (2,5,'Good','Returned');
INSERT INTO LoanItem VALUES (3,9,'Excellent','Included');
INSERT INTO LoanItem VALUES (4,7,'Good','Included');

-- Exhibition
INSERT INTO Exhibition (ExhibitionID, Title, Venue, StartDate, EndDate, StaffID) VALUES (1,'Voices of Industry','BMAG Main Hall', DATE '2025-02-01', DATE '2025-06-30',6);
INSERT INTO Exhibition VALUES (2,'Medieval Manuscripts Revealed','BMAG Reading Room', DATE '2025-03-15', DATE '2025-05-15',4);
INSERT INTO Exhibition VALUES (3,'Roman Britain in the Midlands','BMAG Gallery 1', DATE '2025-01-10', DATE '2025-12-31',4);

-- ExhibitionItem
INSERT INTO ExhibitionItem (ExhibitionID, ObjectID) VALUES (1,2);
INSERT INTO ExhibitionItem VALUES (1,7);
INSERT INTO ExhibitionItem VALUES (2,5);
INSERT INTO ExhibitionItem VALUES (3,3);
INSERT INTO ExhibitionItem VALUES (3,6);

-- ConditionReport
INSERT INTO ConditionReport (ReportID, ObjectID, ReportDate, ConditionStatus, Notes, StaffID) VALUES (1,1, DATE '2025-02-28','Excellent','Pre-loan inspection - no issues',3);
INSERT INTO ConditionReport VALUES (2,4, DATE '2025-02-20','Poor','Surface cracking, needs restoration',3);
INSERT INTO ConditionReport VALUES (3,5, DATE '2025-01-05','Good','Minor foxing on pages',3);
INSERT INTO ConditionReport VALUES (4,8, DATE '2025-03-08','Excellent','Ready for transit',3);
INSERT INTO ConditionReport VALUES (5,3, DATE '2024-12-01','Good','Annual inspection OK',3);
INSERT INTO ConditionReport VALUES (6,2, DATE '2025-04-10','Fair','Rust forming; monitor',3);
INSERT INTO ConditionReport VALUES (7,4, DATE '2025-03-15','AtRisk','Treatment begun',3);
INSERT INTO ConditionReport VALUES (8,6, DATE '2025-06-01','Excellent','Display case cleaned',3);
INSERT INTO ConditionReport VALUES (9,9, DATE '2025-05-01','Good','Fit for outgoing loan',3);
INSERT INTO ConditionReport VALUES (10,1, DATE '2025-06-01','Good','Post-handling inspection OK',3);

-- Movement
INSERT INTO Movement (MovementID, ObjectID, FromLocationID, ToLocationID, MovementDate, StaffID) VALUES (1,8,1,6, DATE '2025-03-10',8);
INSERT INTO Movement VALUES (2,8,6,10, DATE '2025-03-12',8);
INSERT INTO Movement VALUES (3,6,1,3, DATE '2025-01-18',8);
INSERT INTO Movement VALUES (4,4,1,5, DATE '2025-02-18',3);
INSERT INTO Movement VALUES (5,9,3,7, DATE '2025-04-01',9);
INSERT INTO Movement VALUES (6,1,1,6, DATE '2025-03-09',8);
INSERT INTO Movement VALUES (7,1,6,7, DATE '2025-03-10',8);
INSERT INTO Movement VALUES (8,5,2,4, DATE '2025-02-08',8);
INSERT INTO Movement VALUES (9,10,1,10, DATE '2025-07-01',8);
INSERT INTO Movement VALUES (10,2,2,10, DATE '2025-04-14',8);

COMMIT;

-- ================================
-- PART 3: VERIFICATION QUERIES
-- ================================
SELECT 'Contact' AS TableName, COUNT(*) AS RowCount FROM Contact
UNION ALL SELECT 'Staff', COUNT(*) FROM Staff
UNION ALL SELECT 'Location', COUNT(*) FROM Location
UNION ALL SELECT 'Acquisition', COUNT(*) FROM Acquisition
UNION ALL SELECT 'MuseumObject', COUNT(*) FROM MuseumObject
UNION ALL SELECT 'Loan', COUNT(*) FROM Loan
UNION ALL SELECT 'LoanItem', COUNT(*) FROM LoanItem
UNION ALL SELECT 'Exhibition', COUNT(*) FROM Exhibition
UNION ALL SELECT 'ExhibitionItem', COUNT(*) FROM ExhibitionItem
UNION ALL SELECT 'ConditionReport', COUNT(*) FROM ConditionReport
UNION ALL SELECT 'Movement', COUNT(*) FROM Movement;

-- ================================
-- PART 4: SELECT ALL DATA
-- ================================
SELECT * FROM Contact ORDER BY ContactID;
SELECT * FROM Staff ORDER BY StaffID;
SELECT * FROM Location ORDER BY LocationID;
SELECT * FROM Acquisition ORDER BY AcquisitionID;
SELECT * FROM MuseumObject ORDER BY ObjectID;
SELECT * FROM Loan ORDER BY LoanID;
SELECT * FROM LoanItem ORDER BY LoanID, ObjectID;
SELECT * FROM Exhibition ORDER BY ExhibitionID;
SELECT * FROM ExhibitionItem ORDER BY ExhibitionID, ObjectID;
SELECT * FROM ConditionReport ORDER BY ReportID;
SELECT * FROM Movement ORDER BY MovementID;

-- ================================================================
-- PART 5: ANALYTICAL QUERIES
-- ================================================================

-- Query 1: Objects currently on loan with borrower and staff details
SELECT
  mo.ObjectName,
  c.Name AS Borrower,
  lo.LoanType,
  lo.StartDate,
  lo.EndDate,
  s.Name AS StaffSupervisor
FROM Loan lo
JOIN LoanItem li   ON lo.LoanID = li.LoanID
JOIN MuseumObject mo ON li.ObjectID = mo.ObjectID
JOIN Contact c     ON lo.ContactID = c.ContactID
JOIN Staff s       ON lo.StaffID = s.StaffID
WHERE lo.Status = 'Active';

-- Query 2: Objects that have never been loaned
SELECT mo.ObjectName
FROM MuseumObject mo
WHERE NOT EXISTS (
  SELECT 1
  FROM LoanItem li
  WHERE li.ObjectID = mo.ObjectID
);

-- Query 3: Objects with more than one condition report
SELECT mo.ObjectName
FROM MuseumObject mo
WHERE (
  SELECT COUNT(*)
  FROM ConditionReport cr
  WHERE cr.ObjectID = mo.ObjectID
) > 1;

-- Query 4: Movement history of museum objects
SELECT
  mo.ObjectName,
  lf.LocationName AS FromLocation,
  lt.LocationName AS ToLocation,
  m.MovementDate
FROM Movement m
JOIN MuseumObject mo ON m.ObjectID = mo.ObjectID
JOIN Location lf ON m.FromLocationID = lf.LocationID
JOIN Location lt ON m.ToLocationID = lt.LocationID
ORDER BY mo.ObjectName, m.MovementDate;

-- Query 5: Objects that have never been exhibited
SELECT mo.ObjectName
FROM MuseumObject mo
LEFT JOIN ExhibitionItem ei ON mo.ObjectID = ei.ObjectID
WHERE ei.ObjectID IS NULL;

-- Query 6: Loan duration classification
SELECT
  LoanID,
  CASE
    WHEN EndDate - StartDate <= 90 THEN 'Short-term'
    WHEN EndDate - StartDate <= 180 THEN 'Medium-term'
    ELSE 'Long-term'
  END AS LoanDurationType
FROM Loan
WHERE EndDate IS NOT NULL;

-- Query 7: Number of objects displayed in each exhibition
SELECT
  e.Title,
  COUNT(ei.ObjectID) AS TotalObjects
FROM Exhibition e
JOIN ExhibitionItem ei ON e.ExhibitionID = ei.ExhibitionID
GROUP BY e.Title
ORDER BY TotalObjects DESC;

-- Query 8: Objects currently not in storage
SELECT
  ObjectName,
  Status
FROM MuseumObject
WHERE Status <> 'InStorage';

-- ================================================================
-- PART 6: PERFORMANCE OPTIMIZATION
-- ================================================================

-- Capture plan BEFORE optimization
EXPLAIN PLAN FOR
SELECT
  mo.ObjectName,
  c.Name AS Borrower,
  lo.LoanType,
  lo.StartDate,
  lo.EndDate,
  s.Name AS StaffSupervisor
FROM Loan lo
JOIN LoanItem li   ON lo.LoanID = li.LoanID
JOIN MuseumObject mo ON li.ObjectID = mo.ObjectID
JOIN Contact c     ON lo.ContactID = c.ContactID
JOIN Staff s       ON lo.StaffID = s.StaffID
WHERE lo.Status = 'Active';

SELECT * FROM TABLE(DBMS_XPLAN.DISPLAY);

-- Create performance indexes
CREATE INDEX IDX_LOAN_STATUS   ON Loan(Status);
CREATE INDEX IDX_LOANITEM_OBJ  ON LoanItem(ObjectID);
CREATE INDEX IDX_CR_OBJECTDATE ON ConditionReport(ObjectID, ReportDate);

-- Capture plan AFTER optimization (run EXPLAIN PLAN again)

-- ================================================================
-- PART 7: DATA SECURITY - ROLES AND PERMISSIONS
-- ================================================================

-- Enable role creation in PDB (run this if you get ORA-65096)
-- Note: This requires DBA privileges
ALTER SESSION SET "_oracle_script" = TRUE;

-- Create Roles
CREATE ROLE role_collections_staff;
CREATE ROLE role_loans_officer;
CREATE ROLE role_conservator;
CREATE ROLE role_admin;

ALTER SESSION SET "_oracle_script" = FALSE;

-- Grant Permissions to Roles

-- Collections staff: read-only museum data
GRANT SELECT ON MuseumObject TO role_collections_staff;
GRANT SELECT ON Exhibition TO role_collections_staff;
GRANT SELECT ON ExhibitionItem TO role_collections_staff;
GRANT SELECT ON Location TO role_collections_staff;

-- Loans officer: manage loan operations
GRANT SELECT, INSERT, UPDATE ON Loan TO role_loans_officer;
GRANT SELECT, INSERT, UPDATE ON LoanItem TO role_loans_officer;
GRANT SELECT ON Contact TO role_loans_officer;
GRANT SELECT ON MuseumObject TO role_loans_officer;

-- Conservator: condition reports only
GRANT SELECT, INSERT, UPDATE ON ConditionReport TO role_conservator;
GRANT SELECT ON MuseumObject TO role_conservator;

-- Admin: full access (uncomment if needed)
-- GRANT ALL PRIVILEGES TO role_admin;

-- ================================================================
-- PART 8: PUBLIC VIEW (Security through abstraction)
-- ================================================================

-- Public-safe view (hides sensitive notes and acquisition details)
CREATE VIEW vw_PublicMuseumObjects AS
SELECT
  ObjectID,
  ObjectName,
  Category,
  Status
FROM MuseumObject;

-- Grant view access to collections staff
GRANT SELECT ON vw_PublicMuseumObjects TO role_collections_staff;

-- ================================================================
-- SCRIPT COMPLETE
-- ================================================================
SELECT 'Museum Database Setup Complete!' AS Status FROM DUAL;
